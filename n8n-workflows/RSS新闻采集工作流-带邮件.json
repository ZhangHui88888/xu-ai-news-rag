{
  "name": "RSS新闻采集工作流-最终版",
  "nodes": [
    {
      "parameters": {},
      "type": "n8n-nodes-base.manualTrigger",
      "typeVersion": 1,
      "position": [0, 0],
      "id": "5281fd69-72f3-4243-9bc6-d253150c28ba",
      "name": "手动触发"
    },
    {
      "parameters": {
        "jsCode": "const rssSources = [\n  {\n    id: 1,\n    name: '少数派',\n    url: 'https://sspai.com/feed'\n  }\n];\n\nreturn rssSources.map(source => ({ json: source }));"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [224, 0],
      "id": "38c368be-4bc9-4d46-8467-2b8178de1984",
      "name": "RSS源列表"
    },
    {
      "parameters": {
        "url": "={{$json.url}}",
        "options": {}
      },
      "type": "n8n-nodes-base.rssFeedRead",
      "typeVersion": 1.1,
      "position": [448, 0],
      "id": "c631f1e3-e0d6-42b5-83a6-721b7f9c6f1a",
      "name": "读取RSS"
    },
    {
      "parameters": {
        "url": "={{$json.link}}",
        "options": {
          "timeout": 30000
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [672, 0],
      "id": "1ea4b23b-aebc-447c-add1-32e20171552a",
      "name": "获取HTML"
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "const httpResponse = $json;\nconst rssData = $('读取RSS').item.json;\n\nlet html = httpResponse.data || httpResponse.body || httpResponse.response || '';\nif (typeof html === 'object') {\n  html = html.body || html.data || JSON.stringify(html);\n}\nhtml = String(html || '');\n\nlet content = '';\nif (html && html.length > 100) {\n  let cleanHtml = html\n    .replace(/<script[^>]*>.*?<\\/script>/gis, '')\n    .replace(/<style[^>]*>.*?<\\/style>/gis, '')\n    .replace(/<!--.*?-->/gs, '');\n  \n  const articleMatch = cleanHtml.match(/<article[^>]*>(.*?)<\\/article>/is);\n  if (articleMatch) {\n    cleanHtml = articleMatch[1];\n  }\n  \n  content = cleanHtml\n    .replace(/<[^>]+>/g, ' ')\n    .replace(/&nbsp;/g, ' ')\n    .replace(/&[a-z]+;/gi, ' ')\n    .replace(/\\s+/g, ' ')\n    .trim();\n  \n  if (content.length > 5000) {\n    content = content.substring(0, 5000) + '...';\n  }\n}\n\nif (!content || content.length < 50) {\n  content = rssData.description || rssData.contentSnippet || '无内容';\n}\n\nreturn {\n  title: rssData.title || '无标题',\n  content: content,\n  sourceUrl: rssData.link || '',\n  publishedAt: rssData.isoDate || rssData.pubDate || new Date().toISOString(),\n  author: rssData.creator || rssData.author || 'Unknown',\n  tags: rssData.categories || []\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [880, 0],
      "id": "3610424b-d740-46d5-8f59-091f9158df7d",
      "name": "提取内容"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "http://192.168.171.1:11434/api/generate",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "model",
              "value": "qwen3:0.6b"
            },
            {
              "name": "prompt",
              "value": "=请为以下新闻生成一个简洁的中文摘要(不超过200字):\\n\\n标题:{{ $json.title }}\\n\\n内容:{{ $json.content }}\\n\\n只返回摘要内容,不要其他说明。"
            },
            {
              "name": "stream",
              "value": false
            }
          ]
        },
        "options": {
          "timeout": 60000
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [1104, 0],
      "id": "4f27cdcf-d92e-4ce0-b3dd-b903f7c199ec",
      "name": "AI生成摘要"
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "const aiResponse = $json;\nconst originalData = $('提取内容').item.json;\n\nlet summary = '';\nif (aiResponse.response && typeof aiResponse.response === 'string') {\n  summary = aiResponse.response.trim();\n}\n\nreturn {\n  title: originalData.title,\n  content: originalData.content,\n  summary: summary,\n  sourceUrl: originalData.sourceUrl,\n  publishedAt: originalData.publishedAt,\n  author: originalData.author,\n  tags: originalData.tags || [],\n  contentType: 'news',\n  dataSource: 'RSS'\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1328, 0],
      "id": "e3516f2c-a1f2-4861-a599-470c9ed545aa",
      "name": "处理结果"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "http://backend:8080/api/knowledge/import",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ $json }}",
        "options": {
          "timeout": 30000
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [1552, 0],
      "id": "32ff88ec-b8f1-4235-90d3-2da767c2a305",
      "name": "保存到后端"
    },
    {
      "parameters": {
        "jsCode": "const items = $input.all();\nconst successCount = items.filter(item => \n  (item.json.statusCode === 200 || item.json.code === 200)\n).length;\n\nreturn {\n  timestamp: new Date().toISOString(),\n  total: items.length,\n  successCount: successCount,\n  failedCount: items.length - successCount,\n  message: `RSS采集完成: 成功 ${successCount}/${items.length} 条`\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1760, 0],
      "id": "269e3de0-c582-4510-9fb6-6bf3f6ca4d2d",
      "name": "统计结果"
    },
    {
      "parameters": {
        "jsCode": "// 收集采集的文章信息\nconst processedItems = $('处理结果').all();\nconst stats = $json;\n\n// 提取文章列表\nconst articles = processedItems.map(item => ({\n  title: item.json.title || '无标题',\n  summary: item.json.summary || '无摘要',\n  sourceUrl: item.json.sourceUrl || '#',\n  publishedAt: item.json.publishedAt || '',\n  author: item.json.author || '未知'\n})).slice(0, 10);  // 最多显示10篇\n\nconsole.log('收集到的文章数:', articles.length);\n\nreturn {\n  stats: stats,\n  articles: articles,\n  totalArticles: processedItems.length\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1960, 0],
      "id": "collect-articles-info",
      "name": "收集文章信息"
    },
    {
      "parameters": {
        "jsCode": "// 构建HTML邮件内容\nconst data = $json;\nconst stats = data.stats;\nconst articles = data.articles;\n\nconst html = `\n<!DOCTYPE html>\n<html>\n<head>\n  <meta charset=\"utf-8\">\n  <style>\n    body { font-family: 'Microsoft YaHei', Arial, sans-serif; background: #f5f7fa; padding: 20px; margin: 0; }\n    .container { max-width: 800px; margin: 0 auto; background: white; border-radius: 10px; overflow: hidden; box-shadow: 0 2px 12px rgba(0,0,0,0.1); }\n    .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; text-align: center; }\n    .header h1 { margin: 0; font-size: 28px; }\n    .stats { padding: 20px; background: #ecf5ff; display: flex; justify-content: space-around; }\n    .stat-item { text-align: center; }\n    .stat-number { font-size: 32px; font-weight: bold; color: #409eff; }\n    .stat-label { color: #666; margin-top: 5px; }\n    .articles { padding: 20px; }\n    .article-item { border-left: 4px solid #409eff; padding: 15px; margin-bottom: 15px; background: #f9f9f9; border-radius: 4px; }\n    .article-title { font-size: 18px; font-weight: bold; color: #333; margin-bottom: 8px; }\n    .article-title a { color: #409eff; text-decoration: none; }\n    .article-title a:hover { text-decoration: underline; }\n    .article-summary { color: #666; line-height: 1.6; margin-bottom: 8px; }\n    .article-meta { font-size: 12px; color: #999; }\n    .footer { padding: 20px; text-align: center; color: #999; border-top: 1px solid #eee; }\n  </style>\n</head>\n<body>\n  <div class=\"container\">\n    <div class=\"header\">\n      <h1>📰 XU-News AI-RAG 采集报告</h1>\n      <p style=\"margin: 10px 0 0; opacity: 0.9;\">${new Date().toLocaleString('zh-CN')}</p>\n    </div>\n    \n    <div class=\"stats\">\n      <div class=\"stat-item\">\n        <div class=\"stat-number\">${stats.total}</div>\n        <div class=\"stat-label\">处理总数</div>\n      </div>\n      <div class=\"stat-item\">\n        <div class=\"stat-number\" style=\"color: #67c23a;\">${stats.successCount}</div>\n        <div class=\"stat-label\">成功入库</div>\n      </div>\n      <div class=\"stat-item\">\n        <div class=\"stat-number\" style=\"color: #f56c6c;\">${stats.failedCount}</div>\n        <div class=\"stat-label\">失败数量</div>\n      </div>\n    </div>\n    \n    <div class=\"articles\">\n      <h2 style=\"color: #333; border-bottom: 2px solid #409eff; padding-bottom: 10px; margin-top: 0;\">📚 本次采集内容 (共${articles.length}篇)</h2>\n      ${articles.map((article, index) => `\n        <div class=\"article-item\">\n          <div class=\"article-title\">\n            ${index + 1}. <a href=\"${article.sourceUrl}\" target=\"_blank\">${article.title}</a>\n          </div>\n          <div class=\"article-summary\">${article.summary}</div>\n          <div class=\"article-meta\">\n            👤 ${article.author} | 📅 ${new Date(article.publishedAt).toLocaleString('zh-CN')}\n          </div>\n        </div>\n      `).join('')}\n    </div>\n    \n    <div class=\"footer\">\n      <p>🤖 XU-News AI-RAG 自动化新闻采集系统</p>\n      <p>访问系统: <a href=\"http://192.168.171.128:5173\" style=\"color: #409eff;\">http://192.168.171.128:5173</a></p>\n    </div>\n  </div>\n</body>\n</html>\n`;\n\nreturn {\n  html: html,\n  subject: `📰 RSS采集报告 - 成功${stats.successCount}条 | ${new Date().toLocaleDateString('zh-CN')}`,\n  stats: stats,\n  articleCount: articles.length\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [2160, 0],
      "id": "build-html-email",
      "name": "构建HTML邮件"
    },
    {
      "parameters": {
        "sendTo": "652364972@qq.com",
        "subject": "={{ $json.subject }}",
        "message": "={{ $json.html }}",
        "options": {
          "contentType": "html"
        }
      },
      "type": "n8n-nodes-base.emailSend",
      "typeVersion": 2.1,
      "position": [2360, 0],
      "id": "send-email-notification",
      "name": "发送邮件",
      "credentials": {
        "smtp": {
          "id": "smtp-qq",
          "name": "QQ邮箱SMTP"
        }
      }
    }
  ],
  "connections": {
    "手动触发": {
      "main": [[{"node": "RSS源列表", "type": "main", "index": 0}]]
    },
    "RSS源列表": {
      "main": [[{"node": "读取RSS", "type": "main", "index": 0}]]
    },
    "读取RSS": {
      "main": [[{"node": "获取HTML", "type": "main", "index": 0}]]
    },
    "获取HTML": {
      "main": [[{"node": "提取内容", "type": "main", "index": 0}]]
    },
    "提取内容": {
      "main": [[{"node": "AI生成摘要", "type": "main", "index": 0}]]
    },
    "AI生成摘要": {
      "main": [[{"node": "处理结果", "type": "main", "index": 0}]]
    },
    "处理结果": {
      "main": [[{"node": "保存到后端", "type": "main", "index": 0}]]
    },
    "保存到后端": {
      "main": [[{"node": "统计结果", "type": "main", "index": 0}]]
    },
    "统计结果": {
      "main": [[{"node": "收集文章信息", "type": "main", "index": 0}]]
    },
    "收集文章信息": {
      "main": [[{"node": "构建HTML邮件", "type": "main", "index": 0}]]
    },
    "构建HTML邮件": {
      "main": [[{"node": "发送邮件", "type": "main", "index": 0}]]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1"
  },
  "tags": []
}

