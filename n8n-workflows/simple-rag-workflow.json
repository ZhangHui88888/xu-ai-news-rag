{
  "name": "ç®€åŒ–RAGé—®ç­”å·¥ä½œæµ",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "simple-rag",
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "webhook-trigger",
      "name": "Webhookè§¦å‘",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1.1,
      "position": [240, 300]
    },
    {
      "parameters": {
        "jsCode": "// ä¿å­˜åŸå§‹è¯·æ±‚æ•°æ®\nconst input = $json;\n\nconsole.log('=== WebhookåŸå§‹è¾“å…¥ ===');\nconsole.log('å®Œæ•´æ•°æ®:', input);\nconsole.log('body:', input.body);\n\n// æå–queryå’ŒuserId\nconst query = input.body?.query || input.query || '';\nconst userId = input.body?.userId || input.userId || 1;\nconst topK = input.body?.topK || input.topK || 5;\n\nconsole.log('æå–çš„query:', query);\n\n// è¿”å›ç»™åç«¯çš„æ•°æ®\nreturn {\n  query: query,\n  userId: userId,\n  topK: topK,\n  needAnswer: true,\n  similarityThreshold: 0.5,\n  _originalQuery: query,\n  _originalUserId: userId\n};"
      },
      "id": "save-original-request",
      "name": "ä¿å­˜åŸå§‹è¯·æ±‚",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [340, 300]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "http://backend:8080/api/query/ask",
        "sendBody": true,
        "contentType": "json",
        "specifyBody": "json",
        "jsonBody": "={{ $json }}",
        "options": {
          "timeout": 60000
        }
      },
      "id": "call-backend-rag",
      "name": "è°ƒç”¨åç«¯RAG",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [440, 300]
    },
    {
      "parameters": {
        "jsCode": "// ä»è¾“å…¥è·å–ä¹‹å‰ä¿å­˜çš„åŸå§‹query\nconst backendResponse = $json;\nconst inputData = $input.first().json;\n\nconsole.log('=== åˆå¹¶èŠ‚ç‚¹ ===');\nconsole.log('è¾“å…¥æ•°æ®:', inputData);\nconsole.log('åç«¯å“åº”:', backendResponse);\n\nconst originalQuery = inputData._originalQuery || '';\nconst userId = inputData._originalUserId || 1;\n\nconsole.log('æå–çš„originalQuery:', originalQuery);\n\nreturn {\n  ...backendResponse,\n  _query: originalQuery,\n  _userId: userId\n};"
      },
      "id": "merge-query-response",
      "name": "åˆå¹¶queryå’Œå“åº”",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [540, 300]
    },
    {
      "parameters": {
        "jsCode": "// æ£€æŸ¥æ˜¯å¦æœ‰ç»“æœ\nconst response = $json;\nconst originalQuery = response._query;\n\nconsole.log('æ£€æŸ¥ç»“æœ - åŸå§‹é—®é¢˜:', originalQuery);\n\n// æ£€æŸ¥çŸ¥è¯†åº“æ˜¯å¦ä¸ºç©º\nif (response.data && response.data.retrievedEntries && response.data.retrievedEntries.length > 0) {\n  // æœ‰ç»“æœï¼Œç›´æ¥è¿”å›\n  return { \n    hasLocalResult: true, \n    query: originalQuery,\n    backendData: response.data \n  };\n}\n\n// çŸ¥è¯†åº“ä¸ºç©ºï¼Œéœ€è¦è”ç½‘æœç´¢\nreturn { \n  hasLocalResult: false, \n  originalQuery: originalQuery, \n  userId: response._userId || 1 \n};"
      },
      "id": "check-local-result",
      "name": "æ£€æŸ¥æœ¬åœ°ç»“æœ",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [640, 300]
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{$json.hasLocalResult}}",
              "value2": true
            }
          ]
        }
      },
      "id": "check-if-has-result",
      "name": "æ˜¯å¦æœ‰æœ¬åœ°ç»“æœ",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [840, 300]
    },
    {
      "parameters": {
        "jsCode": "// è¿”å›æœ¬åœ°RAGç»“æœ\nconst response = $json;\nreturn {\n  success: true,\n  query: response.data?.query || '',\n  answer: response.data?.answer || '',\n  retrievedDocs: response.data?.retrievedEntries || [],\n  source: 'local_knowledge',\n  responseTimeMs: response.data?.responseTimeMs || 0\n};"
      },
      "id": "format-local-response",
      "name": "æ ¼å¼åŒ–æœ¬åœ°ç»“æœ",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1040, 200]
    },
    {
      "parameters": {
        "jsCode": "// çŸ¥è¯†åº“æ— ç»“æœï¼Œå‡†å¤‡LLMç›´æ¥å›ç­”\nconst query = $json.originalQuery;\n\nconsole.log('çŸ¥è¯†åº“æ— ç»“æœï¼ŒLLMç›´æ¥å›ç­”é—®é¢˜:', query);\n\nreturn {\n  query: query,\n  prompt: `ä½ æ˜¯ä¸€ä¸ªæœ‰å¸®åŠ©çš„AIåŠ©æ‰‹ã€‚ç”¨æˆ·é—®äº†ä¸€ä¸ªé—®é¢˜ï¼Œä½†æœ¬åœ°çŸ¥è¯†åº“ä¸­æš‚æ—¶æ²¡æœ‰ç›¸å…³ä¿¡æ¯ã€‚\\n\\nè¯·åŸºäºä½ çš„çŸ¥è¯†å›ç­”ä»¥ä¸‹é—®é¢˜ï¼ˆç”¨ä¸­æ–‡ï¼‰ï¼š\\n\\n${query}\\n\\nå¦‚æœè¿™ä¸ªé—®é¢˜éœ€è¦æœ€æ–°ä¿¡æ¯æˆ–ä½ ä¸ç¡®å®šç­”æ¡ˆï¼Œè¯·è¯´æ˜æœ¬åœ°çŸ¥è¯†åº“æš‚æ— ç›¸å…³å†…å®¹ï¼Œå»ºè®®ç”¨æˆ·å¯¼å…¥ç›¸å…³èµ„æ–™æˆ–ç­‰å¾…RSSè‡ªåŠ¨é‡‡é›†ã€‚`\n};"
      },
      "id": "prepare-llm-answer",
      "name": "å‡†å¤‡LLMå›ç­”",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1040, 400]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "http://192.168.171.1:11434/api/generate",
        "sendBody": true,
        "contentType": "json",
        "specifyBody": "json",
        "jsonBody": "={{ { \"model\": \"qwen3:0.6b\", \"prompt\": $json.prompt, \"stream\": false, \"options\": { \"temperature\": 0.7 } } }}",
        "options": {
          "timeout": 60000
        }
      },
      "id": "generate-llm-answer",
      "name": "LLMç›´æ¥å›ç­”",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [1440, 400]
    },
    {
      "parameters": {
        "jsCode": "// æ ¼å¼åŒ–LLMå›ç­”\nconst ollama = $json;\nconst query = $input.item.json.query;\n\nconsole.log('LLMå›ç­”:', ollama.response);\n\nreturn {\n  success: true,\n  query: query,\n  answer: (ollama.response || 'æœªèƒ½ç”Ÿæˆç­”æ¡ˆ') + '\\n\\nğŸ’¡ æç¤ºï¼šæ­¤å›ç­”åŸºäºAIæ¨¡å‹çš„é€šç”¨çŸ¥è¯†ã€‚å»ºè®®å¯¼å…¥ç›¸å…³æ–°é—»æˆ–æ–‡æ¡£åˆ°çŸ¥è¯†åº“ä»¥è·å¾—æ›´å‡†ç¡®çš„ç­”æ¡ˆã€‚',\n  retrievedDocs: [],\n  source: 'llm_direct',\n  responseTimeMs: 0\n};"
      },
      "id": "format-llm-response",
      "name": "æ ¼å¼åŒ–LLMå›ç­”",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1640, 400]
    },
    {
      "parameters": {
        "mode": "mergeByPosition"
      },
      "id": "merge",
      "name": "åˆå¹¶",
      "type": "n8n-nodes-base.merge",
      "typeVersion": 2.1,
      "position": [1840, 300]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ $json }}"
      },
      "id": "webhook-response",
      "name": "è¿”å›å“åº”",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [2040, 300]
    }
  ],
  "connections": {
    "Webhookè§¦å‘": {
      "main": [[{"node": "ä¿å­˜åŸå§‹è¯·æ±‚", "type": "main", "index": 0}]]
    },
    "ä¿å­˜åŸå§‹è¯·æ±‚": {
      "main": [[{"node": "è°ƒç”¨åç«¯RAG", "type": "main", "index": 0}]]
    },
    "è°ƒç”¨åç«¯RAG": {
      "main": [[{"node": "åˆå¹¶queryå’Œå“åº”", "type": "main", "index": 0}]]
    },
    "åˆå¹¶queryå’Œå“åº”": {
      "main": [[{"node": "æ£€æŸ¥æœ¬åœ°ç»“æœ", "type": "main", "index": 0}]]
    },
    "æ£€æŸ¥æœ¬åœ°ç»“æœ": {
      "main": [[{"node": "æ˜¯å¦æœ‰æœ¬åœ°ç»“æœ", "type": "main", "index": 0}]]
    },
    "æ˜¯å¦æœ‰æœ¬åœ°ç»“æœ": {
      "main": [
        [{"node": "æ ¼å¼åŒ–æœ¬åœ°ç»“æœ", "type": "main", "index": 0}],
        [{"node": "å‡†å¤‡LLMå›ç­”", "type": "main", "index": 0}]
      ]
    },
    "æ ¼å¼åŒ–æœ¬åœ°ç»“æœ": {
      "main": [[{"node": "åˆå¹¶", "type": "main", "index": 0}]]
    },
    "å‡†å¤‡LLMå›ç­”": {
      "main": [[{"node": "LLMç›´æ¥å›ç­”", "type": "main", "index": 0}]]
    },
    "LLMç›´æ¥å›ç­”": {
      "main": [[{"node": "æ ¼å¼åŒ–LLMå›ç­”", "type": "main", "index": 0}]]
    },
    "æ ¼å¼åŒ–LLMå›ç­”": {
      "main": [[{"node": "åˆå¹¶", "type": "main", "index": 1}]]
    },
    "åˆå¹¶": {
      "main": [[{"node": "è¿”å›å“åº”", "type": "main", "index": 0}]]
    }
  },
  "settings": {
    "executionOrder": "v1"
  }
}

