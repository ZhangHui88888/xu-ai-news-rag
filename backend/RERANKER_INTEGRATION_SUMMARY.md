# é‡æ’æ¨¡å‹é›†æˆæ€»ç»“ âœ…

## ğŸ‰ æ­å–œï¼é‡æ’æ¨¡å‹å·²æˆåŠŸé›†æˆåˆ°æ‚¨çš„é¡¹ç›®ä¸­

---

## ğŸ“¦ å·²å®Œæˆçš„å·¥ä½œ

### 1. âœ… æ–°å¢æ–‡ä»¶

| æ–‡ä»¶ | è¯´æ˜ |
|-----|-----|
| `util/RerankerClient.java` | é‡æ’æ¨¡å‹å®¢æˆ·ç«¯ï¼Œè°ƒç”¨ Cherry Studio API |
| `RERANKER_SETUP_GUIDE.md` | å®Œæ•´é…ç½®æŒ‡å—ï¼ˆæ¨èé˜…è¯»ï¼‰|
| `QUICK_RERANKER_CONFIG.md` | 3åˆ†é’Ÿå¿«é€Ÿé…ç½®æ¸…å• |
| `MODEL_SETUP_GUIDE.md` | æ¨¡å‹æ¦‚å¿µè¯¦è§£ |

### 2. âœ… ä¿®æ”¹æ–‡ä»¶

| æ–‡ä»¶ | ä¿®æ”¹å†…å®¹ |
|-----|---------|
| `application.yml` | æ·»åŠ é‡æ’æ¨¡å‹é…ç½® |
| `QueryServiceImpl.java` | é›†æˆé‡æ’åŠŸèƒ½åˆ°æŸ¥è¯¢æœåŠ¡ |

### 3. âœ… æ–°å¢é…ç½®é¡¹

```yaml
# application.yml
reranker:
  enabled: true  # å¯ç”¨é‡æ’
  base-url: https://api.siliconflow.cn
  api-key: ${RERANKER_API_KEY}  # éœ€è¦é…ç½®
  model: BAAI/bge-reranker-v2-m3
  candidate-multiplier: 4
```

---

## ğŸš€ æ‚¨è¿˜éœ€è¦åšçš„äº‹æƒ…

### âš ï¸ å¿…é¡»å®Œæˆï¼ˆå¦åˆ™æ— æ³•è¿è¡Œï¼‰

#### 1. è·å–å¹¶é…ç½® API Key

**æ–¹å¼ 1: ç¯å¢ƒå˜é‡ï¼ˆæ¨èï¼‰**
```bash
# Windows PowerShell
$env:RERANKER_API_KEY="sk-ä½ çš„å®é™…API_KEY"

# Linux/Mac
export RERANKER_API_KEY="sk-ä½ çš„å®é™…API_KEY"
```

**æ–¹å¼ 2: ç›´æ¥ä¿®æ”¹é…ç½®æ–‡ä»¶**
```yaml
# application.yml
reranker:
  api-key: sk-ä½ çš„å®é™…API_KEY
```

#### 2. é‡å¯æœåŠ¡
```bash
cd backend
mvn spring-boot:run
```

### ğŸ“– æ¨èé˜…è¯»ï¼ˆäº†è§£è¯¦æƒ…ï¼‰

1. **[QUICK_RERANKER_CONFIG.md](./QUICK_RERANKER_CONFIG.md)** - 3åˆ†é’Ÿå¿«é€Ÿä¸Šæ‰‹
2. **[RERANKER_SETUP_GUIDE.md](./RERANKER_SETUP_GUIDE.md)** - å®Œæ•´é…ç½®å’Œä¼˜åŒ–æŒ‡å—
3. **[MODEL_SETUP_GUIDE.md](./MODEL_SETUP_GUIDE.md)** - ç†è§£åµŒå…¥æ¨¡å‹ã€é‡æ’æ¨¡å‹ã€LLM

---

## ğŸ¯ å·¥ä½œæµç¨‹è¯´æ˜

### å¯ç”¨é‡æ’å‰ï¼ˆåªç”¨å‘é‡æ£€ç´¢ï¼‰

```
ç”¨æˆ·æŸ¥è¯¢
   â†“
å‘é‡æ£€ç´¢ â†’ ç›´æ¥è¿”å› Top 5
```

### å¯ç”¨é‡æ’åï¼ˆä¸¤é˜¶æ®µæ£€ç´¢ï¼‰

```
ç”¨æˆ·æŸ¥è¯¢
   â†“
[é˜¶æ®µ1] å‘é‡æ£€ç´¢ï¼ˆå¬å›ï¼‰
   â†’ å¿«é€Ÿç­›é€‰å‡º 20 ä¸ªå€™é€‰æ–‡æ¡£
   â†“
[é˜¶æ®µ2] é‡æ’æ¨¡å‹ï¼ˆç²¾æ’ï¼‰
   â†’ ç²¾ç¡®è¯„åˆ†ï¼Œé€‰å‡ºæœ€ç›¸å…³çš„ 5 ä¸ª
   â†“
è¿”å›ç»“æœï¼ˆå‡†ç¡®ç‡æå‡ 20-30%ï¼‰
```

---

## ğŸ“Š æŠ€æœ¯æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            QueryServiceImpl.java                â”‚
â”‚                                                 â”‚
â”‚  query() {                                      â”‚
â”‚    1. å‘é‡åŒ–æŸ¥è¯¢                                 â”‚
â”‚       â†“                                         â”‚
â”‚    2. å‘é‡æ£€ç´¢ï¼ˆå¬å› topK Ã— 4ï¼‰                  â”‚
â”‚       â†“                                         â”‚
â”‚    3. é‡æ’æ¨¡å‹ï¼ˆç²¾ç¡®æ‰“åˆ†ï¼‰â† RerankerClient       â”‚
â”‚       â†“                                         â”‚
â”‚    4. LLM ç”Ÿæˆç­”æ¡ˆ                               â”‚
â”‚  }                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“                    â†“
   VectorStore          RerankerClient
         â†“                    â†“
   FAISS å‘é‡åº“     Cherry Studio API
                  (BAAI/bge-reranker-v2-m3)
```

---

## ğŸ” ä»£ç ç¤ºä¾‹

### é‡æ’å®¢æˆ·ç«¯ä½¿ç”¨

```java
@Autowired
private RerankerClient rerankerClient;

// é‡æ’æ–‡æ¡£
List<String> documents = Arrays.asList(
    "Pythonæ–‡ä»¶æ“ä½œè¯¦è§£",
    "æ–‡ä»¶ç³»ç»ŸåŸºç¡€",
    "Pythonå…¥é—¨æ•™ç¨‹"
);

List<RerankResult> results = rerankerClient.rerank(
    "Pythonå¦‚ä½•è¯»å–æ–‡ä»¶ï¼Ÿ",  // æŸ¥è¯¢
    documents,              // å€™é€‰æ–‡æ¡£
    3                       // è¿”å›å‰3ä¸ª
);

// ç»“æœæŒ‰ç›¸å…³æ€§æ’åº
for (RerankResult result : results) {
    System.out.println("æ–‡æ¡£ç´¢å¼•: " + result.getIndex());
    System.out.println("ç›¸å…³æ€§åˆ†æ•°: " + result.getRelevanceScore());
}
```

### æŸ¥è¯¢æœåŠ¡ä½¿ç”¨

```java
QueryRequest request = new QueryRequest();
request.setQuery("ä»€ä¹ˆæ˜¯äººå·¥æ™ºèƒ½ï¼Ÿ");
request.setTopK(5);
request.setNeedAnswer(true);

QueryResponse response = queryService.query(request, userId);
// è‡ªåŠ¨ä½¿ç”¨é‡æ’ï¼ˆå¦‚æœå¯ç”¨ï¼‰
```

---

## ğŸ›ï¸ é…ç½®é€‰é¡¹è¯¦è§£

### reranker.enabled
- **é»˜è®¤å€¼ï¼š** `false`
- **ç”Ÿäº§å»ºè®®ï¼š** `true`
- **è¯´æ˜ï¼š** æ˜¯å¦å¯ç”¨é‡æ’åŠŸèƒ½

### reranker.model
- **å½“å‰å€¼ï¼š** `BAAI/bge-reranker-v2-m3`
- **è¯´æ˜ï¼š** æ‚¨åœ¨ Cherry Studio ä¸­ä¸‹è½½çš„æ¨¡å‹
- **æ— éœ€ä¿®æ”¹**ï¼ˆé™¤éä½¿ç”¨å…¶ä»–æ¨¡å‹ï¼‰

### reranker.candidate-multiplier
- **é»˜è®¤å€¼ï¼š** `4`
- **èŒƒå›´ï¼š** `2-10`
- **è¯´æ˜ï¼š** å¬å›å€™é€‰æ•° = topK Ã— multiplier
- **ç¤ºä¾‹ï¼š** topK=5, multiplier=4 â†’ å¬å›20ä¸ªï¼Œé‡æ’åè¿”å›5ä¸ª
- **è°ƒä¼˜ï¼š**
  - `2-3`: é€Ÿåº¦å¿«ï¼Œæ•ˆæœç•¥é™
  - `4-5`: å¹³è¡¡ï¼ˆæ¨èï¼‰
  - `6-10`: æ•ˆæœå¥½ï¼Œé€Ÿåº¦æ…¢

---

## ğŸ§ª æµ‹è¯•éªŒè¯

### 1. å¯åŠ¨æœåŠ¡æµ‹è¯•

```bash
cd backend
mvn spring-boot:run
```

**é¢„æœŸæ—¥å¿—ï¼š**
```
INFO  c.x.n.u.RerankerClient - é‡æ’æ¨¡å‹å·²å¯ç”¨: BAAI/bge-reranker-v2-m3
INFO  c.x.n.XuNewsApplication - Started XuNewsApplication
```

### 2. å‘èµ·æŸ¥è¯¢æµ‹è¯•

```bash
curl -X POST http://localhost:8080/api/query \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -d '{
    "query": "æµ‹è¯•æŸ¥è¯¢",
    "topK": 5,
    "needAnswer": true
  }'
```

**é¢„æœŸæ—¥å¿—ï¼š**
```
DEBUG c.x.n.s.i.QueryServiceImpl - æ£€ç´¢ç›¸å…³æ–‡æ¡£ï¼ŒCandidateCount=20, Threshold=0.5
DEBUG c.x.n.s.i.QueryServiceImpl - æ‰§è¡Œé‡æ’åº: å€™é€‰æ–‡æ¡£æ•°=15, ç›®æ ‡TopK=5
INFO  c.x.n.u.RerankerClient - é‡æ’è¯·æ±‚: query=æµ‹è¯•æŸ¥è¯¢, documents=15, topK=5
INFO  c.x.n.u.RerankerClient - é‡æ’å®Œæˆ: è¾“å…¥æ–‡æ¡£æ•°=15, è¾“å‡ºç»“æœæ•°=5
INFO  c.x.n.s.i.QueryServiceImpl - é‡æ’å®Œæˆ: è¾“å…¥å€™é€‰æ•°=15, è¾“å‡ºç»“æœæ•°=5
```

### 3. å¯¹æ¯”æµ‹è¯•ï¼ˆå¯é€‰ï¼‰

**ç¦ç”¨é‡æ’ï¼š**
```yaml
reranker:
  enabled: false
```

**å¯ç”¨é‡æ’ï¼š**
```yaml
reranker:
  enabled: true
```

å¯¹æ¯”ä¸¤æ¬¡æŸ¥è¯¢ç»“æœçš„ç›¸å…³æ€§å’Œå‡†ç¡®ç‡ã€‚

---

## ğŸ“ˆ æ€§èƒ½æŒ‡æ ‡

| æŒ‡æ ‡ | æœªå¯ç”¨é‡æ’ | å¯ç”¨é‡æ’ | å˜åŒ– |
|-----|-----------|---------|-----|
| **å‡†ç¡®ç‡** | åŸºå‡† | åŸºå‡† + 20-30% | â¬†ï¸ |
| **å¬å›æ•°é‡** | 5 | 20 â†’ 5 | â¬†ï¸â¬‡ï¸ |
| **å“åº”æ—¶é—´** | ~200ms | ~400-700ms | â¬†ï¸ |
| **API è°ƒç”¨** | 2æ¬¡ | 3æ¬¡ | â¬†ï¸ |
| **æˆæœ¬** | ä½ | ä¸­ï¼ˆ+0.0025å…ƒ/æ¬¡ï¼‰ | â¬†ï¸ |

**ç»“è®ºï¼š** ä»¥å°‘é‡æ€§èƒ½å’Œæˆæœ¬æ¢å–æ˜¾è‘—çš„å‡†ç¡®ç‡æå‡ï¼Œ**æ¨èå¯ç”¨**ã€‚

---

## ğŸ› å¸¸è§é—®é¢˜

### Q1: API Key ä»å“ªé‡Œè·å–ï¼Ÿ

**A:** 
1. Cherry Studio â†’ è®¾ç½® â†’ API é…ç½®
2. æˆ–è®¿é—® https://cloud.siliconflow.cn/ â†’ æ§åˆ¶å° â†’ APIå¯†é’¥

### Q2: æ˜¯å¦å¿…é¡»ä½¿ç”¨ Cherry Studioï¼Ÿ

**A:** 
ä¸æ˜¯å¿…é¡»çš„ã€‚ä»»ä½•æ”¯æŒ `BAAI/bge-reranker-v2-m3` çš„æœåŠ¡éƒ½å¯ä»¥ï¼Œåªéœ€ä¿®æ”¹ `reranker.base-url` å³å¯ã€‚

### Q3: é‡æ’å¤±è´¥æ€ä¹ˆåŠï¼Ÿ

**A:** 
ä»£ç å·²ç»å®ç°äº†ä¼˜é›…é™çº§ã€‚å¦‚æœé‡æ’å¤±è´¥ï¼Œä¼šè‡ªåŠ¨å›é€€åˆ°åªä½¿ç”¨å‘é‡æ£€ç´¢çš„ç»“æœï¼Œä¸ä¼šå½±å“ç³»ç»Ÿæ­£å¸¸è¿è¡Œã€‚

### Q4: å¦‚ä½•ä¸´æ—¶ç¦ç”¨é‡æ’ï¼Ÿ

**A:** 
```yaml
reranker:
  enabled: false
```
æˆ–è®¾ç½®ç¯å¢ƒå˜é‡ï¼š
```bash
export RERANKER_ENABLED=false
```

### Q5: è´¹ç”¨å¦‚ä½•ï¼Ÿ

**A:** 
SiliconFlow å®šä»·çº¦ Â¥0.001/1000 tokensã€‚å•æ¬¡æŸ¥è¯¢ï¼ˆ5ä¸ªæ–‡æ¡£Ã—500å­—ï¼‰â‰ˆ Â¥0.0025ï¼Œ1000æ¬¡æŸ¥è¯¢çº¦ Â¥2.5ã€‚é€šå¸¸æœ‰å…è´¹é¢åº¦ã€‚

---

## ğŸ” å®‰å…¨å»ºè®®

### âš ï¸ ä¸è¦å°† API Key æäº¤åˆ° Git

**æ¨èåšæ³•ï¼š**

1. **ä½¿ç”¨ç¯å¢ƒå˜é‡**ï¼ˆå·²å®ç°ï¼‰
```yaml
api-key: ${RERANKER_API_KEY}
```

2. **æ·»åŠ åˆ° .gitignore**
```gitignore
# ç¯å¢ƒé…ç½®
.env
application-local.yml
```

3. **å›¢é˜Ÿåä½œ**
å°† API Key é€šè¿‡å®‰å…¨æ¸ é“åˆ†äº«ï¼Œä¸è¦æ”¾åœ¨ä»£ç ä»“åº“ä¸­ã€‚

---

## ğŸ“š å‚è€ƒèµ„æº

### é¡¹ç›®æ–‡æ¡£
- [QUICK_RERANKER_CONFIG.md](./QUICK_RERANKER_CONFIG.md) - å¿«é€Ÿé…ç½®
- [RERANKER_SETUP_GUIDE.md](./RERANKER_SETUP_GUIDE.md) - è¯¦ç»†æŒ‡å—
- [MODEL_SETUP_GUIDE.md](./MODEL_SETUP_GUIDE.md) - æ¨¡å‹è¯´æ˜

### å¤–éƒ¨èµ„æº
- [BAAI/bge-reranker-v2-m3](https://huggingface.co/BAAI/bge-reranker-v2-m3) - æ¨¡å‹ä¸»é¡µ
- [SiliconFlow æ–‡æ¡£](https://docs.siliconflow.cn/) - API æ–‡æ¡£
- [Cherry Studio](https://github.com/kangfenmao/cherry-studio) - å®¢æˆ·ç«¯

---

## âœ… å®Œæˆæ¸…å•

é›†æˆå®Œæˆåï¼Œè¯·ç¡®è®¤ï¼š

- [ ] âœ… ä»£ç å·²ä¿®æ”¹ï¼ˆ`RerankerClient.java`, `QueryServiceImpl.java`ï¼‰
- [ ] âœ… é…ç½®å·²æ·»åŠ ï¼ˆ`application.yml`ï¼‰
- [ ] ğŸ“ **è·å– API Key**ï¼ˆCherry Studio / SiliconFlowï¼‰
- [ ] ğŸ“ **é…ç½® API Key**ï¼ˆç¯å¢ƒå˜é‡æˆ–é…ç½®æ–‡ä»¶ï¼‰
- [ ] ğŸ“ **å¯åŠ¨æœåŠ¡**ï¼ˆ`mvn spring-boot:run`ï¼‰
- [ ] ğŸ“ **æŸ¥çœ‹æ—¥å¿—**ï¼ˆç¡®è®¤é‡æ’æ¨¡å‹åŠ è½½æˆåŠŸï¼‰
- [ ] ğŸ“ **æµ‹è¯•æŸ¥è¯¢**ï¼ˆå‘èµ·è¯·æ±‚å¹¶éªŒè¯æ—¥å¿—ï¼‰
- [ ] ğŸ“ **å¯¹æ¯”æ•ˆæœ**ï¼ˆå¯é€‰ï¼Œå¯¹æ¯”å¯ç”¨å‰åçš„å‡†ç¡®ç‡ï¼‰

---

## ğŸ“ ä¸‹ä¸€æ­¥å»ºè®®

### 1. æ€§èƒ½ä¼˜åŒ–
- æ·»åŠ é‡æ’ç»“æœç¼“å­˜
- ä½¿ç”¨å¼‚æ­¥è°ƒç”¨æå‡å“åº”é€Ÿåº¦
- ç›‘æ§ API è°ƒç”¨é‡å’Œæˆæœ¬

### 2. åŠŸèƒ½æ‰©å±•
- æ”¯æŒåŠ¨æ€è°ƒæ•´ `candidate-multiplier`
- å®ç° A/B æµ‹è¯•æ¡†æ¶
- æ·»åŠ é‡æ’æ•ˆæœè¯„ä¼°æŒ‡æ ‡

### 3. ç”Ÿäº§éƒ¨ç½²
- é…ç½®å¤šä¸ª API Key å®ç°è´Ÿè½½å‡è¡¡
- æ·»åŠ é™çº§ç­–ç•¥ï¼ˆAPI é™æµæ—¶è‡ªåŠ¨ç¦ç”¨ï¼‰
- ç›‘æ§å‘Šè­¦ï¼ˆAPI è°ƒç”¨å¤±è´¥ç‡ã€å“åº”æ—¶é—´ï¼‰

---

## ğŸ†˜ è·å–å¸®åŠ©

é‡åˆ°é—®é¢˜ï¼Ÿ

1. ğŸ“– æŸ¥çœ‹æ—¥å¿—ï¼š`./logs/xu-news-rag.log`
2. ğŸ“š é˜…è¯»æ–‡æ¡£ï¼šæŸ¥çœ‹ä¸Šè¿°å‚è€ƒèµ„æº
3. ğŸ” æœç´¢é”™è¯¯ï¼šå°†é”™è¯¯ä¿¡æ¯å¤åˆ¶åˆ°æœç´¢å¼•æ“
4. ğŸ’¬ æäº¤ Issueï¼šé™„ä¸Šå®Œæ•´æ—¥å¿—å’Œé…ç½®
5. ğŸ“§ è”ç³»æ”¯æŒï¼šsupport@xu-news-rag.com

---

**ç¥æ‚¨ä½¿ç”¨æ„‰å¿«ï¼é‡æ’æ¨¡å‹å°†å¤§å¹…æå‡æ‚¨çš„ RAG ç³»ç»Ÿå‡†ç¡®ç‡ã€‚ğŸš€**

---

*é›†æˆæ—¥æœŸ: 2025-10-16*  
*ç‰ˆæœ¬: 1.0.0*

